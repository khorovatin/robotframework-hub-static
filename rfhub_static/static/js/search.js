document.addEventListener('DOMContentLoaded', function () {
    const searchInput = document.getElementById('search-input');
    const searchResults = document.getElementById('search-results');
    let documents = [];
    let lunrIndex;

    // Fetch the search index data generated by the Python script
    fetch('search_index.json')
        .then(response => response.json())
        .then(data => {
            documents = data;
            // Initialize the Lunr.js index
            lunrIndex = lunr(function () {
                // The ref is the unique identifier for each document
                this.ref('url');

                // Define the fields to be searched
                this.field('name', { boost: 10 }); // Boost name matches
                this.field('library');

                // Add each document to the index
                documents.forEach(doc => {
                    this.add(doc);
                });
            });
        }).catch(error => {
            console.error('Error loading search index:', error);
            if (searchResults) {
                searchResults.innerHTML = '<li>Error loading search index.</li>';
            }
        });

    // Add an event listener to the search input field
    if (searchInput) {
        searchInput.addEventListener('input', function (event) {
            const query = event.target.value.trim();

            // Perform search only if the query is long enough
            if (query.length < 2) {
                searchResults.innerHTML = ''; // Clear results for short queries
                return;
            }

            // Perform the search on the Lunr index
            const results = lunrIndex.search(query);
            displayResults(results);
        });
    }

    /**
     * Renders the search results on the page.
     * @param {Array} results - An array of result objects from Lunr.js.
     */
    function displayResults(results) {
        if (!searchResults) return;

        searchResults.innerHTML = ''; // Clear previous results

        if (results.length === 0) {
            searchResults.innerHTML = '<ul><li>No keywords found.</li></ul>';
            return;
        }

        const resultList = document.createElement('ul');
        results.slice(0, 50).forEach(result => { // Limit to 50 results
            // Find the original document by the reference (URL)
            const item = documents.find(doc => doc.url === result.ref);
            if (item) {
                const listItem = document.createElement('li');
                const link = document.createElement('a');
                link.href = item.url;
                link.textContent = `${item.name}`;

                const librarySpan = document.createElement('span');
                librarySpan.className = 'library-name';
                librarySpan.textContent = ` (in ${item.library})`;

                listItem.appendChild(link);
                listItem.appendChild(librarySpan);
                resultList.appendChild(listItem);
            }
        });
        searchResults.appendChild(resultList);
    }
});
